<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Catégorie : {{ categorie.nom }}</title>
	<meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
</head>
<body data-add-url="{{ url_for('inventaire.ajouter_objet') }}">
    {% include 'header.html' %}
    <div class="main-container">
		{% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
		{% endwith %}
        <nav class="breadcrumb-nav">
            <a href="{{ url_for('main.gestion_categories') }}" class="breadcrumb-link">
                <span class="breadcrumb-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M160-480v240-480 240Zm400 360q17 0 28.5-11.5T600-160q0-17-11.5-28.5T560-200q-17 0-28.5 11.5T520-160q0 17 11.5 28.5T560-120Zm240-400q17 0 28.5-11.5T840-560q0-17-11.5-28.5T800-600q-17 0-28.5 11.5T760-560q0 17 11.5 28.5T800-520Zm-560 0h200v-80H240v80Zm0 160h200v-80H240v80Zm-80 200q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720H160v480h200v80H160ZM560-40q-50 0-85-35t-35-85q0-39 22.5-70t57.5-43v-127h240v-47q-35-12-57.5-43T680-560q0-50 35-85t85-35q50 0 85 35t35 85q0 39-22.5 70T840-447v127H600v47q35 12 57.5 43t22.5 70q0 50-35 85t-85 35Z"/></svg>
                </span>
                <span class="breadcrumb-text">Accès aux Catégories</span>
            </a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ categorie.nom }}</span>
        </nav>

        <div class="table-header">
            <h2 class="page-title">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M160-480v240-480 240Zm400 360q17 0 28.5-11.5T600-160q0-17-11.5-28.5T560-200q-17 0-28.5 11.5T520-160q0 17 11.5 28.5T560-120Zm240-400q17 0 28.5-11.5T840-560q0-17-11.5-28.5T800-600q-17 0-28.5 11.5T760-560q0 17 11.5 28.5T800-520Zm-560 0h200v-80H240v80Zm0 160h200v-80H240v80Zm-80 200q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720H160v480h200v80H160ZM560-40q-50 0-85-35t-35-85q0-39 22.5-70t57.5-43v-127h240v-47q-35-12-57.5-43T680-560q0-50 35-85t85-35q50 0 85 35t35 85q0 39-22.5 70T840-447v127H600v47q35 12 57.5 43t22.5 70q0 50-35 85t-85 35Z"/></svg>
                <span>Objets dans la catégorie : <strong>{{ categorie.nom }}</strong></span>
            </h2>
        </div>

        <div id="inventory-content" 
             data-sort-by="{{ sort_by }}" 
             data-direction="{{ direction }}" 
             data-categorie-id="{{ categorie.id }}">
            
            <table class="objet-table">
                <thead>
                    <tr>
						{% if session.user_role == 'admin' %}<th class="checkbox-column"><input type="checkbox" id="select-all-checkbox" title="Tout sélectionner"></th>{% endif %}
						
						<th class="sortable {% if sort_by == 'nom' %}th-sort-{{ direction }}{% endif %}">
							<a href="{{ url_for(pagination.endpoint, categorie_id=pagination.categorie_id, page=pagination.page, sort_by='nom', direction='desc' if sort_by == 'nom' and direction == 'asc' else 'asc') }}">Nom</a>
						</th>
						<th class="sortable {% if sort_by == 'quantite' %}th-sort-{{ direction }}{% endif %}">
							<a href="{{ url_for(pagination.endpoint, categorie_id=pagination.categorie_id, page=pagination.page, sort_by='quantite', direction='desc' if sort_by == 'quantite' and direction == 'asc' else 'asc') }}">Quantité</a>
						</th>
						<th class="sortable {% if sort_by == 'seuil' %}th-sort-{{ direction }}{% endif %}">
							<a href="{{ url_for(pagination.endpoint, categorie_id=pagination.categorie_id, page=pagination.page, sort_by='seuil', direction='desc' if sort_by == 'seuil' and direction == 'asc' else 'asc') }}">Seuil</a>
						</th>
						<th class="sortable {% if sort_by == 'date_peremption' %}th-sort-{{ direction }}{% endif %}">
							<a href="{{ url_for(pagination.endpoint, categorie_id=pagination.categorie_id, page=pagination.page, sort_by='date_peremption', direction='desc' if sort_by == 'date_peremption' and direction == 'asc' else 'asc') }}">Péremption</a>
						</th>
						<th class="sortable {% if sort_by == 'armoire' %}th-sort-{{ direction }}{% endif %}">
							<a href="{{ url_for(pagination.endpoint, categorie_id=pagination.categorie_id, page=pagination.page, sort_by='armoire', direction='desc' if sort_by == 'armoire' and direction == 'asc' else 'asc') }}">Armoire</a>
						</th>
						
						<th>Image</th>
						<th>État</th>
						{% if session.user_id %}<th>Actions</th>{% endif %}
					</tr>
                </thead>
                <tbody>
                    {% for objet in objets %}
                    {% set perime, perime_bientot, statut = False, False, 'ok' %}
                    {% if objet.date_peremption %}
                        {% set date_peremption_obj = date_actuelle.strptime(objet.date_peremption, '%Y-%m-%d') %}
                        {% if date_peremption_obj < date_actuelle %}{% set perime, statut = True, 'perime' %}
                        {% elif (date_peremption_obj - date_actuelle).days <= 30 %}{% set perime_bientot, statut = True, 'bientot' %}
                        {% endif %}
                    {% endif %}
                    {# === CORRECTION 1 === #}
                    {% if statut == 'ok' and objet.quantite_disponible <= objet.seuil %}{% set statut = 'stock' %}{% endif %}

                    <tr class="{{ 'row-perime' if perime else 'row-perime-bientot' if perime_bientot }}" data-objet-id="{{ objet.id }}">
                        {% if session.user_role == 'admin' %}<td class="checkbox-column"><input type="checkbox" class="objet-checkbox" data-id="{{ objet.id }}"></td>{% endif %}
                        <td data-field="nom"><a href="{{ url_for('inventaire.voir_objet', objet_id=objet.id) }}">{{ objet.nom }}</a></td>
                        {# === CORRECTION 2 === #}
                        <td data-field="quantite">{{ objet.quantite_disponible }}</td>
                        <td data-field="seuil">{{ objet.seuil }}</td>
                        <td data-field="date_peremption" class="{{ 'texte-perime' if perime else 'texte-perime-bientot' if perime_bientot }}">{{ date_peremption_obj.strftime('%d/%m/%Y') if objet.date_peremption }}</td>
                        <td data-field="armoire">{{ objet.armoire }}</td>
                        <td class="image-cell">
                            {% if objet.image %}
                            <div class="image-preview-wrapper">
                                <img src="{{ url_for('main.serve_image', filename=objet.image) }}" class="image-objet-thumbnail" alt="Image de {{ objet.nom }}">
                                <img src="{{ url_for('main.serve_image', filename=objet.image) }}" class="image-objet-preview" alt="Aperçu de {{ objet.nom }}">
                            </div>
                            {% endif %}
                        </td>
                        <td data-type="alerte" data-alerte-status="{{ statut }}">
                            {% if statut == 'perime' %}<span class="texte-perime" title="Produit périmé. A recycler !"><svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 -960 960 960"><path d="M240-80v-170q-39-17-68.5-45.5t-50-64.5q-20.5-36-31-77T80-520q0-158 112-259t288-101q176 0 288 101t112 259q0 42-10.5 83t-31 77q-20.5 36-50 64.5T720-250v170H240Zm80-80h40v-80h80v80h80v-80h80v80h40v-142q38-9 67.5-30t50-50q20.5-29 31.5-64t11-74q0-125-88.5-202.5T480-800q-143 0-231.5 77.5T160-520q0 39 11 74t31.5 64q20.5 29 50.5 50t67 30v142Zm100-200h120l-60-120-60 120Zm-80-80q33 0 56.5-23.5T420-520q0-33-23.5-56.5T340-600q-33 0-56.5 23.5T260-520q0 33 23.5 56.5T340-440Zm280 0q33 0 56.5-23.5T700-520q0-33-23.5-56.5T620-600q-33 0-56.5 23.5T540-520q0 33 23.5 56.5T620-440ZM480-160Z"/></svg></span>
                            {% elif statut == 'bientot' %}<span class="texte-perime-bientot" title="Expire bientôt"><svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 -960 960 960"><path d="M480-520q66 0 113-47t47-113v-120H320v120q0 66 47 113t113 47ZM160-80v-80h80v-120q0-61 28.5-114.5T348-480q-51-32-79.5-85.5T240-680v-120h-80v-80h640v80h-80v120q0 61-28.5 114.5T612-480q51 32 79.5 85.5T720-280v120h80v80H160Z"/></svg></span>
                            {% elif statut == 'stock' %}<span class="texte-alerte" title="Stock bas"><svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 -960 960 960"><path d="M320-80q-17 0-28.5-11.5T280-120v-640q0-17 11.5-28.5T320-800h80v-80h160v80h80q17 0 28.5 11.5T680-760v308q-22 6-42 15.5T600-414v-306H360v560h148q5 22 14.5 42T545-80H320Zm40-80Zm296 80-56-56 84-84-84-84 56-56 84 84 84-84 56 56-83 84 83 84-56 56-84-83-84 83Z"/></svg></span>
                            {% else %}<span class="texte-ok" title="OK"><svg xmlns="http://www.w3.org/2000/svg" class="icon-svg" viewBox="0 -960 960 960"><path d="M320-80q-17 0-28.5-11.5T280-120v-640q0-17 11.5-28.5T320-800h80v-80h160v80h80q17 0 28.5 11.5T680-760v640q0 17-11.5 28.5T640-80H320Z"/></svg></span>
                            {% endif %}
                        </td>
                        {% if session.user_id %}
                        <td>
                            <button class="btn-action edit-objet-btn"
                                    data-objet-id="{{ objet.id }}"
                                    data-armoire-id="{{ objet.armoire_id }}"
                                    data-categorie-id="{{ objet.categorie_id }}"
                                    data-nom="{{ objet.nom }}"
                                    {# === CORRECTION 3 === #}
                                    data-quantite="{{ objet.quantite_physique }}"
                                    data-seuil="{{ objet.seuil }}"
                                    data-date-peremption="{{ objet.date_peremption or '' }}"
                                    data-image-url="{{ url_for('static', filename='images/objets/' + objet.image) if objet.image else '' }}"
                                    data-modal-trigger="add-object-modal">
                                Modifier
                            </button>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% include '_pagination.html' %}
        </div>

        {% if session.user_role == 'admin' %}
        <div id="bulk-action-section" class="bulk-action-container" style="display: none;">
			<label for="move-destination">Déplacer la sélection vers la catégorie :</label>
			<select id="move-destination">
				{% for c in categories_list %}
					{# On peut optionnellement exclure la catégorie actuelle de la liste #}
					{% if c.id != categorie.id %}
						<option value="{{ c.id }}">{{ c.nom }}</option>
					{% endif %}
				{% endfor %}
			</select>
			<button id="bulk-move-btn" class="btn-action">Déplacer</button>
		</div>
        {% endif %}

    </div>

    {% include 'footer.html' %}
    {% include 'modale_objet.html' %}
</body>
</html>